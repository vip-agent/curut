<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investasi Saham GIAA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .header-gradient {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <!-- Loading Transition Overlay (Ditambahkan untuk jeda 1.5 detik) -->
    <div id="transitionOverlay" class="fixed inset-0 bg-white/90 hidden flex items-center justify-center z-[600] opacity-0 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <!-- Spinner -->
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
            <p class="text-lg font-semibold text-blue-700">Memuat Antarmuka...</p>
        </div>
    </div>
    
    <div id="app" class="max-w-4xl mx-auto">
        <!-- Header & OJK Disclaimer -->
        <header class="header-gradient p-5 rounded-xl mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Garuda Invest Pro (G-Invest)</h1>
                <p class="text-sm font-light opacity-80">Antarmuka Aplikasi Investasi Saham</p>
            </div>
            <!-- LOGIN/LOGOUT BUTTON -->
            <button id="auth-status-button" class="py-2 px-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                <span id="auth-status-text">Log In</span>
            </button>
        </header>

        <!-- Withdrawal Pending Status Bar -->
        <div id="withdrawalStatusBox" class="bg-indigo-100 p-4 rounded-xl card-shadow mb-6 border-l-4 border-indigo-500 hidden">
            <h3 class="font-bold text-indigo-800 flex items-center mb-1">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                TRANSAKSI DANA SEDANG DIPROSES
            </h3>
            <p class="text-sm text-indigo-700 font-semibold">
                Dana penarikan akan diterima maksimal 24 jam kerja.
            </p>
        </div>
        <!-- END Withdrawal Pending Status Bar -->

        <!-- Login Modal/Screen -->
        <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-50">
            <div id="loginModalContent" class="bg-white p-8 rounded-xl max-w-sm w-full card-shadow text-center" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold mb-6 text-blue-700">Masuk ke G-Invest</h3>
                
                <form id="loginForm">
                    <div class="mb-4">
                        <!-- Nomor HP sudah diisi otomatis (default value) -->
                        <input type="text" id="loginPhone" value="081226418380" placeholder="Nomor HP (e.g., 0812...)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-6">
                         <!-- Password sudah diisi otomatis (default value) -->
                        <input type="password" id="loginPassword" value="qwerty123" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-200 shadow-lg">
                        Login
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Main Content Grid Wrapper -->
        <div id="main-content" class="hidden">
            <!-- PENDING STATUS BAR (HANYA UNTUK PEMBERITAHUAN PEMBELIAN) -->
            <div id="pendingStatusBox" class="bg-yellow-100 p-4 rounded-xl card-shadow mb-6 border-l-4 border-yellow-500">
                <h3 class="font-bold text-yellow-800 flex items-center mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 2v6"/><path d="M12 18v4"/><path d="M4.93 4.93l3.54 3.54"/><path d="M15.53 15.53l3.54 3.54"/><path d="M2 12h6"/><path d="M18 12h4"/><path d="M4.93 19.07l3.54-3.54"/><path d="M15.53 8.47l3.54-3.54"/><circle cx="12" cy="12" r="7"/></svg>
                    Transaksi Pembelian Tertunda
                </h3>
                <p class="text-sm text-yellow-700 font-semibold" id="pendingMessage">
                    Transfer Anda telah dikonfirmasi. Status transaksi saat ini adalah **menunggu verifikasi kliring dan penyelesaian**. Nilai portofolio Anda akan tetap pada nominal saat ini tanpa perubahan apa pun, tanpa batas waktu.
                </p>
            </div>
            <!-- END PENDING STATUS BAR -->

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Saham GIAA Details -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Saham GIAA Overview Card -->
                    <div class="bg-white p-6 rounded-xl card-shadow">
                        <div class="flex items-center mb-4">
                            <!-- Placeholder image for logo -->
                            <img src="https://placehold.co/40x40/007bff/ffffff?text=GI" alt="Logo Garuda Indonesia" class="w-10 h-10 rounded-full mr-3 border-2 border-blue-100">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">PT Garuda Indonesia (Persero) Tbk.</h2>
                                <p class="text-3xl font-extrabold text-blue-600">GIAA <span class="text-base font-normal text-gray-500">di BEI</span></p>
                            </div>
                        </div>
                        <div class="mb-5">
                            <p class="text-5xl font-extrabold text-green-600" id="current-price">115</p>
                            <p class="text-lg font-semibold text-green-600" id="price-change">+9 (+8.49%)</p>
                            <p class="text-sm text-gray-500 mt-1">Pergerakan Hari Ini: 106 - 115</p>
                        </div>

                        <!-- Trading Action Buttons: TOMBOL JUAL DIKUNCI JIKA LOT DIMILIKI == 0 -->
                        <div class="flex space-x-4">
                            <button id="sellBtn" class="flex-1 py-3 px-4 bg-red-500 text-white font-semibold rounded-lg transition duration-200 shadow-lg">
                                Jual
                            </button>
                            <button id="buyBtn" class="flex-1 py-3 px-4 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition duration-200 shadow-lg">
                                Beli
                            </button>
                        </div>
                    </div>

                    <!-- Informasi Perusahaan Card -->
                    <div class="bg-white p-6 rounded-xl card-shadow">
                        <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">Informasi Perusahaan</h3>
                        <div class="space-y-3 text-gray-600">
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">Sektor</span>
                                <span>Transportasi & Logistik (Penerbangan)</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">Kapitalisasi Pasar</span>
                                <span id="market-cap">Rp 10.52 Triliun</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">P/E Ratio</span>
                                <span class="text-red-500" id="pe-ratio">-5.5x</span>
                            </div>
                            
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">Jabatan Kontak Investor</span>
                                <span class="font-semibold text-gray-800">VP Financial Accounting</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">Nama Kontak Investor</span>
                                <span class="font-semibold text-gray-800">Gatot Satriawan</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="font-medium">Email Investor</span>
                                <span>ccfoundation.volunteer@gmail.com</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Profil, Portofolio & Berita -->
                <div class="lg:col-span-1 space-y-6">
                     <!-- Profil Pengguna Card -->
                    <div class="bg-indigo-50 p-6 rounded-xl card-shadow border-2 border-indigo-200">
                        <h3 class="text-xl font-bold mb-4 text-indigo-800 flex justify-between items-center">
                            Profil Pengguna
                            <!-- Icon User/Profile -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-lg border-l-4 border-indigo-500">
                                <p class="text-xs text-gray-500">Nama Pengguna</p>
                                <span class="text-lg font-bold text-indigo-700" id="user-name"></span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border-l-4 border-indigo-500">
                                <p class="text-xs text-gray-500">Nomor Rekening Nasabah</p>
                                <span class="text-sm font-medium text-gray-600 truncate" id="user-id"></span>
                            </div>
                            
                            <!-- RDN Balance (Cash) -->
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-yellow-500">
                                <span class="font-medium text-gray-700">Saldo Kas RDN (Cash)</span>
                                <span class="text-xl font-bold text-yellow-600" id="rdn-cash-balance">Rp 0</span> 
                            </div>

                             <!-- Portofolio Value in Profile -->
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-blue-500">
                                <span class="font-medium text-gray-700">Nilai Portofolio Saham (GIAA)</span>
                                <span class="text-xl font-bold text-blue-600" id="profile-portfolio-value">Rp 0</span> 
                            </div>

                            <!-- Total Equity (Sum) -->
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-green-500">
                                <span class="font-medium text-gray-700">Total Nilai Akun</span>
                                <span class="text-xl font-bold text-green-600" id="total-equity-balance">Rp 0</span> 
                            </div>
                        </div>
                        <!-- BUTTON AKSI DANA DIPERBARUI (TARIK DANA) -->
                        <button id="withdrawalBtn" class="w-full mt-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition duration-200 shadow-md">
                            TARIK DANA
                        </button>
                    </div>

                    <!-- Portofolio Card -->
                    <div class="bg-blue-50 p-6 rounded-xl card-shadow border-2 border-blue-200">
                        <h3 class="text-xl font-bold mb-4 text-blue-800">Portofolio Anda</h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-blue-500">
                                <span class="font-medium text-gray-700">Lot Dimiliki</span>
                                <span class="text-xl font-bold text-blue-700" id="lot-owned">0 Lot</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-green-500">
                                <span class="font-medium text-gray-700">Nilai Portofolio (GIAA)</span>
                                <span class="text-xl font-bold text-green-600" id="portfolio-value">Rp 0</span>
                            </div>
                            <div class="text-xs text-center text-gray-500 pt-2">
                                Aplikasi ini terhubung ke Rekening Dana Nasabah (RDN Anda).
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Modal (Order Jual/Beli) -->
            <div id="orderModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
                <div id="orderModalContent" class="bg-white p-6 rounded-xl max-w-lg w-full card-shadow" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-4 border-b pb-2" id="modalTitle">Order Saham</h3>
                    <form id="orderForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Tipe Order</label>
                            <select id="orderType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="Limit">Limit Order</option>
                                <option value="Market">Market Order (Harga Saat Ini)</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="price" class="block text-gray-700 font-semibold mb-2">Harga (Rp/Lembar)</label>
                            <input type="number" id="price" min="50" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="115" required>
                            <p class="text-xs text-gray-500 mt-1">Harga minimum saham adalah Rp 50.</p>
                        </div>
                        <div class="mb-6">
                            <label for="lots" id="lotsLabel" class="block text-gray-700 font-semibold mb-2">Jumlah Lot (1 Lot = 100 Lembar)</label>
                            <input type="number" id="lots" min="1" value="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                            <!-- Minimum Lot Warning for Buy -->
                            <p id="minLotWarning" class="text-xs text-red-500 mt-2 hidden">Pembelian wajib minimal 479 lot.</p>
                            <p id="buyMethodText" class="text-xs text-blue-600 mt-1">Pembelian akan diproses melalui transfer bank manual, bukan dari Saldo RDN.</p>
                        </div>
                        <div class="text-right">
                            <button type="button" id="cancelOrderBtn" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg mr-2 transition duration-200">Batal</button>
                            <button type="submit" id="submitButton" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200">Konfirmasi Order</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Modal (Pembayaran Order Beli) -->
            <div id="paymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center p-4 z-50">
                <div id="paymentModalContent" class="bg-white p-6 rounded-xl max-w-md w-full card-shadow text-center" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-4 text-green-700 border-b pb-2">Menunggu Pembayaran Order Beli</h3>
                    
                    <p class="text-sm text-gray-600 mb-2">Segera lakukan transfer dalam waktu:</p>
                    <div class="bg-red-500 text-white font-extrabold text-4xl p-3 rounded-lg mb-4 shadow-inner">
                        <span id="paymentTimer">01:00:00</span>
                    </div>

                    <p class="text-xs text-red-500 font-semibold mb-3">Order akan otomatis dibatalkan jika waktu habis.</p>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-left mb-4">
                        <p class="text-lg font-semibold text-gray-700 mb-2">Jumlah yang Harus Ditransfer:</p>
                        <p class="text-4xl font-extrabold text-blue-600" id="paymentAmount">Rp 0</p>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300 text-left mb-6">
                        <p class="text-sm font-semibold mb-3 text-gray-700">Detail Rekening Tujuan Pembayaran:</p>
                        <div class="space-y-2">
                            <!-- Bank Name -->
                            <div class="flex justify-between items-center text-sm">
                                <span>Bank: <span class="font-bold text-gray-800" id="paymentBank">BRI</span></span>
                            </div>
                            <!-- Account Number with Copy Button -->
                            <div class="flex justify-between items-center text-base">
                                <span class="font-medium text-gray-600">Nomor Rekening:</span>
                                <div class="flex items-center space-x-2">
                                    <span class="font-bold text-red-600 text-lg" id="paymentAccount">459801043667539</span>
                                    <button type="button" onclick="copyToClipboard('459801043667539', 'Nomor Rekening')" class="text-blue-500 hover:text-blue-700 transition duration-150 p-1 rounded-full bg-blue-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                    </button>
                                </div>
                            </div>
                            <!-- Recipient Name with Copy Button -->
                            <div class="flex justify-between items-center text-base">
                                <span class="font-medium text-gray-600">Nama Penerima:</span>
                                <div class="flex items-center space-x-2">
                                    <span class="font-bold text-gray-800" id="paymentRecipient">GATOT SATRIAWAN</span>
                                    <button type="button" onclick="copyToClipboard('GATOT SATRIAWAN', 'Nama Penerima')" class="text-blue-500 hover:text-blue-700 transition duration-150 p-1 rounded-full bg-blue-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-red-500 mt-2">Pastikan jumlah transfer sama persis dengan nominal di atas.</p>
                    </div>

                    <button id="paymentConfirmBtn" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-200 shadow-lg">
                        Selesai, Saya Sudah Transfer
                    </button>
                </div>
            </div>
            <!-- END Modal (Pembayaran Order Beli) -->


            <!-- Modal (Penarikan Dana RDN) -->
            <div id="withdrawalModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
                <div id="withdrawalModalContent" class="bg-white p-6 rounded-xl max-w-lg w-full card-shadow" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-4 text-indigo-700 border-b pb-2">Penarikan Saldo Kas RDN</h3>
                    <form id="withdrawalForm">
                        
                        <div class="bg-yellow-50 p-3 rounded-lg mb-4 border border-yellow-200">
                            <p class="text-sm font-semibold text-gray-700">Saldo RDN Tersedia:</p>
                            <p class="text-2xl font-bold text-yellow-600" id="modal-rdn-balance">Rp 0</p>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Tarik Ke Rekening Tujuan</label>
                            <div class="p-3 bg-gray-100 rounded-lg border border-gray-300">
                                <p class="text-sm text-gray-600">Nama: <span class="font-medium" id="modal-user-name"></span></p>
                                <p class="text-sm text-gray-600">No. Rek: <span class="font-medium" id="modal-user-id"></span></p>
                                <p class="text-xs text-gray-500 mt-1">Pencairan dana akan dilakukan ke rekening yang terdaftar.</p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label for="withdrawalAmount" class="block text-gray-700 font-semibold mb-2">Jumlah Penarikan (Rp)</label>
                            <input type="number" id="withdrawalAmount" min="1000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" value="100000" required>
                            <p class="text-xs text-gray-500 mt-1">Minimum penarikan adalah Rp 1.000.</p>
                        </div>

                        <div class="text-right">
                            <button type="button" id="cancelWithdrawalBtn" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg mr-2 transition duration-200">Batal</button>
                            <button type="submit" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-200">Konfirmasi Tarik Dana</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- END Modal (Penarikan Dana RDN) -->

            <!-- HILANGKAN: Notification Message Box lama -->
            <!-- <div id="notificationBox" class="fixed right-4 text-white p-4 rounded-lg shadow-xl hidden opacity-0 transition-opacity duration-300 z-[500]">
                Notifikasi
            </div> -->
        </div>
    </div>
    
    <!-- FOOTER DITAMBAHKAN: Diawasi OJK dan Jasa Keuangan Nasional -->
    <footer class="max-w-4xl mx-auto mt-8 p-4 text-center text-gray-500 text-sm border-t border-gray-200">
        <p>Garuda Invest Pro (G-Invest) berizin dan diawasi oleh Otoritas Jasa Keuangan (OJK).</p>
    </footer>
    <!-- AKHIR FOOTER -->

    <!-- NEW: KOTAK NOTIFIKASI PERINGATAN (Footer Level) - DIGUNAKAN UNTUK SEMUA NOTIFIKASI SEMENTARA -->
    <!-- Z-index dinaikkan menjadi 550 untuk menutupi elemen lain (kecuali modal) -->
    <div id="footerWarningBox" class="fixed bottom-0 left-0 right-0 p-4 text-white text-center shadow-2xl z-[550] hidden opacity-0 transition-all duration-300 transform translate-y-full" style="background-color: #e53e3e;">
        <div id="footerWarningContent">
             <!-- Content will be set by JS: Title + Message -->
        </div>
    </div>
    <!-- END NEW WARNING BOX -->

    <script type="module">
        // ** CONSTANTS UNTUK PERSISTENSI LOGIN (LOCAL STORAGE) **
        const LOGGED_IN_KEY = 'isLoggedIn_GInvest';
        const USER_ID_KEY = 'loggedInUserId_GInvest';
        
        // ** AUTH CONFIG & GLOBALS **
        // Kredensial Asli (Tidak Diumumkan ke User)
        const CORRECT_PHONE = "081226418380";
        const CORRECT_PASSWORD = "qwerty123";
        // ID Nasabah RDN permanen
        const RDN_ACCOUNT_NUMBER = "688301025037535";
        const USER_NAME = "Bagus Ramadhani"; 
        
        let currentUserId = null; // null jika belum login
        
        // ** PAYMENT CONSTANTS **
        const PAYMENT_BANK = "BRI";
        const PAYMENT_ACCOUNT = "459801043667539";
        const PAYMENT_RECIPIENT = "GATOT SATRIAWAN";
        const MIN_BUY_LOTS = 479; // DIUBAH DARI 800 KE 479
        const RDN_UNLOCK_THRESHOLD = 10000000; 

        // ** DOM REFERENCES **
        const priceElement = document.getElementById('current-price');
        const changeElement = document.getElementById('price-change');
        const orderModal = document.getElementById('orderModal'); 
        const withdrawalModal = document.getElementById('withdrawalModal'); 
        const paymentModal = document.getElementById('paymentModal');
        const modalTitle = document.getElementById('modalTitle');
        const submitButton = document.getElementById('submitButton');
        const priceInput = document.getElementById('price');
        const orderTypeSelect = document.getElementById('orderType');
        
        // ** NOTIFIKASI LAMA DIHILANGKAN, SEKARANG HANYA MENGGUNAKAN footerWarningBox (Namun nama variabel tetap ada untuk notifikasi standar) **
        // const notificationBox = document.getElementById('notificationBox'); 
        
        const lotsInput = document.getElementById('lots');
        const authStatusButton = document.getElementById('auth-status-button');
        const authStatusText = document.getElementById('auth-status-text');
        const loginModal = document.getElementById('loginModal'); 
        const mainContent = document.getElementById('main-content');
        const minLotWarning = document.getElementById('minLotWarning');
        const buyMethodText = document.getElementById('buyMethodText'); 
        const transitionOverlay = document.getElementById('transitionOverlay');

        // ** DOM REFERENCES BARU UNTUK WARNING DAN LISTENER **
        const footerWarningBox = document.getElementById('footerWarningBox');
        const footerWarningContent = document.getElementById('footerWarningContent');
        const pendingStatusBox = document.getElementById('pendingStatusBox');
        const pendingMessage = document.getElementById('pendingMessage');
        const withdrawalStatusBox = document.getElementById('withdrawalStatusBox'); // Status bar yang harus disembunyikan
        
        // ** DOM REFERENCES BARU UNTUK LISTENER **
        const loginForm = document.getElementById('loginForm');
        const orderForm = document.getElementById('orderForm');
        const withdrawalForm = document.getElementById('withdrawalForm');
        const sellBtn = document.getElementById('sellBtn');
        const buyBtn = document.getElementById('buyBtn');
        const withdrawalBtn = document.getElementById('withdrawalBtn');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const cancelWithdrawalBtn = document.getElementById('cancelWithdrawalBtn');
        const orderModalContent = document.getElementById('orderModalContent');
        const withdrawalModalContent = document.getElementById('withdrawalModalContent');
        // PAYMENT MODAL REFERENCES
        const paymentModalContent = document.getElementById('paymentModalContent');
        const paymentTimerElement = document.getElementById('paymentTimer');
        const paymentAmountElement = document.getElementById('paymentAmount');
        const paymentConfirmBtn = document.getElementById('paymentConfirmBtn');


        // ** DATA PENGGUNA & STATE APLIKASI **
        const minWithdrawal = 1000; 
        
        // Saldo RDN awal yang diperbarui berdasarkan permintaan user (70.506.500 + 5.500.000 = 76.006.500)
        const INITIAL_RDN_BALANCE = 76006500;

        // State yang dapat berubah (dinyatakan dengan 'let')
        let lotOwned = 0; 
        let rdnBalance = INITIAL_RDN_BALANCE; 
        let isTransactionPending = false; 
        let hasMadeFirstPurchase = false; // Diubah ke false untuk simulasi awal
        let isWithdrawalPending = false; 
        let timerInterval; 
        
        // Data awal default jika belum ada data di LocalStorage
        const INITIAL_STATE = {
            lotOwned: 0, 
            rdnBalance: INITIAL_RDN_BALANCE, // Menggunakan nilai yang baru
            isTransactionPending: false, 
            hasMadeFirstPurchase: false, // Menggunakan nilai yang baru
            isWithdrawalPending: false, 
        };

        // Konstanta Saham GIAA (Statik)
        const currentPrice = 115; 
        const priceChange = 9;
        const percentChange = ((priceChange / (currentPrice - priceChange)) * 100).toFixed(2);

        // Helper: Format Rupiah (Miliar/Juta)
        function formatRupiah(number) {
            const absNumber = Math.abs(number);
            const sign = number < 0 ? '-' : '';

            if (absNumber >= 1000000000) {
                return sign + 'Rp ' + (absNumber / 1000000000).toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' Miliar';
            }
            // Khusus untuk tampilan Saldo RDN, tampilkan dalam format penuh jika kurang dari 1 M, atau dalam Juta jika ingin lebih singkat.
            // Kita akan mempertahankan format penuh untuk kejelasan, kecuali angkanya sangat besar.
            if (absNumber >= 1000000) {
                return sign + 'Rp ' + absNumber.toLocaleString('id-ID'); 
            }
            return sign + 'Rp ' + absNumber.toLocaleString('id-ID');
        }
        
        // FUNGSI TRANSISI
        function startTransition(callback, duration = 1500) {
            transitionOverlay.classList.remove('hidden', 'opacity-0');
            transitionOverlay.classList.add('opacity-100');

            setTimeout(() => {
                callback(); 
                
                transitionOverlay.classList.remove('opacity-100');
                setTimeout(() => {
                    transitionOverlay.classList.add('hidden');
                }, 300); 
                
            }, duration);
        }

        // ** FUNGSI PERMANENSI DATA (Local Storage) **

        // 1. Simpan data ke LocalStorage
        function saveData() {
            if (currentUserId) { 
                const dataToSave = {
                    lotOwned,
                    rdnBalance,
                    isTransactionPending,
                    hasMadeFirstPurchase, 
                    isWithdrawalPending, 
                };
                localStorage.setItem(`user_data_${currentUserId}`, JSON.stringify(dataToSave));
                // console.log(`[Persist] Data pengguna ${currentUserId} disimpan.`);
            }
        }

        // 2. Muat data dari LocalStorage
        function loadData() {
            if (currentUserId) {
                const savedData = localStorage.getItem(`user_data_${currentUserId}`);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Pastikan hanya memuat data yang ada (handle nilai null/undefined)
                    lotOwned = parsedData.lotOwned !== undefined ? parsedData.lotOwned : INITIAL_STATE.lotOwned;
                    rdnBalance = parsedData.rdnBalance !== undefined ? parsedData.rdnBalance : INITIAL_STATE.rdnBalance;
                    isTransactionPending = parsedData.isTransactionPending !== undefined ? parsedData.isTransactionPending : INITIAL_STATE.isTransactionPending; 
                    hasMadeFirstPurchase = parsedData.hasMadeFirstPurchase !== undefined ? parsedData.hasMadeFirstPurchase : INITIAL_STATE.hasMadeFirstPurchase; 
                    isWithdrawalPending = parsedData.isWithdrawalPending !== undefined ? parsedData.isWithdrawalPending : INITIAL_STATE.isWithdrawalPending; 
                    // console.log(`[Persist] Data pengguna ${currentUserId} berhasil dimuat.`);
                } else {
                    // Jika tidak ada data tersimpan, gunakan data awal dan simpan
                    lotOwned = INITIAL_STATE.lotOwned;
                    rdnBalance = INITIAL_RDN_BALANCE; // Menggunakan konstanta RDN awal
                    isTransactionPending = INITIAL_STATE.isTransactionPending;
                    hasMadeFirstPurchase = INITIAL_STATE.hasMadeFirstPurchase; 
                    isWithdrawalPending = INITIAL_STATE.isWithdrawalPending; 
                    saveData(); 
                    // console.log(`[Persist] Menggunakan data default dan disimpan.`);
                }
            }
        }


        // FUNGSI UTAMA: MENGHITUNG DAN MEMPERBARUI SELURUH UI
        function updateUI() {
            // 1. Perhitungan Ulang
            const totalShares = lotOwned * 100;
            const portfolioValueRaw = totalShares * currentPrice; 
            const totalEquity = rdnBalance + portfolioValueRaw;

            // 2. Update Portofolio Card
            document.getElementById('lot-owned').textContent = `${lotOwned.toLocaleString('id-ID')} Lot`;
            document.getElementById('portfolio-value').textContent = formatRupiah(portfolioValueRaw);
            
            // 3. Update Profil Pengguna Card
            document.getElementById('rdn-cash-balance').textContent = formatRupiah(rdnBalance); 
            document.getElementById('profile-portfolio-value').textContent = formatRupiah(portfolioValueRaw);
            document.getElementById('total-equity-balance').textContent = formatRupiah(totalEquity); 
            
            // Set User Name and ID in Profile card
            document.getElementById('user-name').textContent = USER_NAME; 
            document.getElementById('user-id').textContent = currentUserId || "---";

            // 4. Update Pending Status UI (Pembelian)
            if (isTransactionPending) {
                pendingStatusBox.classList.remove('hidden');
            } else {
                pendingStatusBox.classList.add('hidden');
            }
            
            // 5. Update Pending Status UI (Penarikan Dana)
            if (isWithdrawalPending) {
                withdrawalStatusBox.classList.remove('hidden');
            } else {
                withdrawalStatusBox.classList.add('hidden');
            }

            // 6. Update Tombol Jual/Sell Button State (Logika Penguncian Baru)
            const isUnlockedByRules = hasMadeFirstPurchase || rdnBalance > RDN_UNLOCK_THRESHOLD;
            
            if (lotOwned > 0 && isUnlockedByRules) {
                sellBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                sellBtn.classList.add('hover:bg-red-600');
            } else {
                sellBtn.classList.add('opacity-50', 'cursor-not-allowed');
                sellBtn.classList.remove('hover:bg-red-600');
            }
        }
        
        // FUNGSI INTI: MENGHITUNG DAN MEMPERBARUI SELURUH UI
        function handleOrder(event) {
            event.preventDefault();
            
            if (!currentUserId) {
                showNotification("Anda harus Log In terlebih dahulu untuk melakukan transaksi.", false);
                return;
            }

            const action = submitButton.textContent.includes('Beli') ? 'Pembelian' : 'Penjualan';
            const price = parseInt(priceInput.value, 10);
            const lots = parseInt(lotsInput.value, 10);
            const totalNominal = price * lots * 100;

            let message = '';
            let isSuccess = true;

            if (action === 'Penjualan') {
                // --- LOGIKA PENJUALAN (IMMEDIATE EXECUTION) ---
                
                const isUnlockedByRules = hasMadeFirstPurchase || rdnBalance > RDN_UNLOCK_THRESHOLD;
                
                if (!isUnlockedByRules) {
                    message = "Penjualan saham akan berlaku jika user sudah melakukan pembelian saham pertama di aplikasi, atau saldo kas RDN Anda melebihi Rp 10 Juta.";
                    isSuccess = false;
                } else if (lots > lotOwned) {
                    message = `GAGAL: Lot yang dijual (${lots.toLocaleString('id-ID')} Lot) melebihi Lot yang dimiliki (${lotOwned.toLocaleString('id-ID')} Lot).`;
                    isSuccess = false;
                } else {
                    // Lakukan transaksi Penjualan yang Berhasil
                    lotOwned -= lots; 
                    rdnBalance += totalNominal; 
                    
                    isWithdrawalPending = false; // Membatalkan status pending penarikan dana

                    message = `Order Penjualan ${lots.toLocaleString('id-ID')} Lot @ Rp ${price.toLocaleString('id-ID')} berhasil dieksekusi! Saldo Kas RDN bertambah sebesar ${formatRupiah(totalNominal)}.`;
                }

                if (isSuccess) {
                    updateUI(); 
                    saveData(); 
                }
                showNotification(message, isSuccess);
                hideModal();

            } else {
                // --- LOGIKA PEMBELIAN (Pembayaran via Transfer Manual) ---

                if (lots < MIN_BUY_LOTS) {
                    message = `GAGAL: Pembelian awal wajib minimal ${MIN_BUY_LOTS.toLocaleString('id-ID')} Lot.`;
                    isSuccess = false;
                } 
                
                if (isSuccess) {
                    startPaymentFlow(lots, price, totalNominal);
                } else {
                     showNotification(message, false);
                }
            }
        }
        
        // FUNGSI INTI: MENANGANI LOGIKA PENARIKAN DANA (FUNGSI DIKEMBALIKAN)
        function handleWithdrawal(event) {
            event.preventDefault();
            
            if (!currentUserId) {
                showNotification("Anda harus Log In terlebih dahulu untuk melakukan penarikan dana.", false, "Akses Ditolak");
                return;
            }

            const amount = parseInt(document.getElementById('withdrawalAmount').value, 10);
            
            // 1. Validasi Minimum Penarikan
            if (amount < minWithdrawal) {
                showNotification(`GAGAL: Minimum penarikan dana adalah ${formatRupiah(minWithdrawal)}.`, false, "Penarikan Gagal");
                return;
            }

            // 2. Validasi Saldo RDN
            if (amount > rdnBalance) {
                showNotification("GAGAL: Jumlah penarikan melebihi Saldo Kas RDN yang tersedia.", false, "Penarikan Gagal");
                return;
            }

            // 3. Logika Sukses (Dikembalikan)
            rdnBalance -= amount; // Kurangi saldo
            isWithdrawalPending = true; // Set status pending

            closeWithdrawalModal(); // Tutup modal

            updateUI(); // Update UI dengan saldo baru dan status pending
            saveData(); // Simpan state

            showNotification(`Penarikan dana sebesar ${formatRupiah(amount)} berhasil diajukan. Status transaksi sedang diproses.`, true, "Penarikan Diajukan");
        }


        // ** FUNGSI FLOW PEMBAYARAN **
        
        // Helper: Format Waktu (HH:MM:SS)
        function formatTime(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        
        function startPaymentFlow(lots, price, nominal) {
            hideModal(); 
            
            paymentAmountElement.textContent = formatRupiah(nominal);
            document.getElementById('paymentBank').textContent = PAYMENT_BANK;
            document.getElementById('paymentAccount').textContent = PAYMENT_ACCOUNT;
            document.getElementById('paymentRecipient').textContent = PAYMENT_RECIPIENT;
            
            paymentModal.classList.remove('hidden');

            let duration = 60 * 60; 
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            function runTimer() {
                if (duration <= 0) {
                    clearInterval(timerInterval);
                    paymentTimerElement.textContent = "00:00:00";
                    showNotification("Waktu pembayaran telah habis. Order dibatalkan.", false, "Order Dibatalkan");
                    closePaymentModal();
                } else {
                    paymentTimerElement.textContent = formatTime(duration);
                    duration--;
                }
            }

            runTimer();
            timerInterval = setInterval(runTimer, 1000);
        }

        function closePaymentModal() {
            paymentModal.classList.add('hidden');
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function handlePaymentConfirmation() {
            closePaymentModal(); 

            isTransactionPending = true;
            hasMadeFirstPurchase = true; 
            
            saveData(); 

            updateUI(); 

            showNotification("Transfer dikonfirmasi! Transaksi Anda telah masuk antrian kliring. Nilai portofolio Anda tidak akan berubah sampai status kliring selesai (diluar simulasi ini).", true, "Order Beli Diterima");
        }

        // Helper: Copy to Clipboard
        function copyToClipboard(text, fieldName) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showNotification(`${fieldName} berhasil disalin!`, true, "Salin Berhasil");
            } catch (err) {
                showNotification(`Gagal menyalin ${fieldName}.`, false, "Salin Gagal");
            }
            document.body.removeChild(tempInput);
        }
        window.copyToClipboard = copyToClipboard; 

        // FUNGSI INTI UNTUK NOTIFIKASI GABUNGAN
        function showNotification(message, isSuccessParam = null, title = null) {
            
            // Tentukan warna latar belakang
            let bgColor = 'background-color: #3b82f6;'; // Default biru (seperti sukses)
            if (!isSuccessParam && title && title.includes("GAGAL")) {
                 // Kasus Kegagalan Umum (Merah)
                 bgColor = 'background-color: #dc2626;'; // Tailwind red-600
            } else if (!isSuccessParam) {
                 // Kasus Kegagalan Umum (Merah)
                 bgColor = 'background-color: #dc2626;'; // Tailwind red-600
            } else {
                 // Kasus Sukses (Hijau)
                 bgColor = 'background-color: #16a34a;'; // Tailwind green-600
            }

            // Tentukan Judul Default jika tidak disediakan
            if (!title) {
                title = isSuccessParam ? "Berhasil" : "Gagal";
            }
            
            // Isi konten footerWarningBox
            footerWarningContent.innerHTML = `
                <div class="text-xl font-extrabold flex items-center justify-center mb-1">
                    <!-- Icon Warning/Success (Menggunakan tanda seru untuk peringatan dan ceklist untuk sukses/berhasil) -->
                    ${isSuccessParam ? 
                        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg>' 
                        : 
                        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                    }
                    ${title}
                </div>
                <p class="text-sm font-semibold">${message}</p>
            `;
            
            footerWarningBox.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 1rem;
                color: white;
                text-align: center;
                box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
                z-index: 550;
                transition: all 300ms ease-out;
                transform: translateY(100%);
                opacity: 0;
                ${bgColor}
            `;

            // Tampilkan Notifikasi
            footerWarningBox.classList.remove('hidden');
            
            // Paksa reflow sebelum memulai transisi untuk memastikan elemen dirender
            void footerWarningBox.offsetWidth;
            
            // Pindahkan ke posisi terlihat
            footerWarningBox.style.transform = 'translateY(0)';
            footerWarningBox.style.opacity = '1';

            setTimeout(() => {
                // Sembunyikan setelah 5 detik
                footerWarningBox.style.transform = 'translateY(100%)';
                footerWarningBox.style.opacity = '0';
                
                setTimeout(() => {
                    footerWarningBox.classList.add('hidden');
                }, 300); // Tunggu transisi selesai
            }, 5000); // Durasi 5 detik
        }


        // ** FUNGSI AUTHENTICATION **

        function showAppContent(show) {
            mainContent.classList.toggle('hidden', !show);
            loginModal.classList.toggle('hidden', show);
        }

        function updateAuthUI() {
            if (currentUserId) {
                // Logged In State
                authStatusText.textContent = "Log Out";
                authStatusButton.classList.remove('bg-gray-500');
                authStatusButton.classList.add('bg-red-500', 'hover:bg-red-600');
                showAppContent(true);
            } else {
                // Logged Out State
                authStatusText.textContent = "Log In";
                authStatusButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                authStatusButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
                showAppContent(false);
            }
        }
        
        function handleAuthAction() {
            if (currentUserId) {
                // Log Out Logic: Menghapus status login dari Local Storage
                
                startTransition(() => {
                    // Hapus status login dan ID pengguna dari Local Storage
                    localStorage.removeItem(LOGGED_IN_KEY);
                    localStorage.removeItem(USER_ID_KEY);
                    
                    // Kunci untuk data portofolio TIDAK dihapus, agar sesi berikutnya dapat memuat data yang tersimpan
                    // localStorage.removeItem(`user_data_${currentUserId}`); 

                    currentUserId = null;
                    // Reset state in-memory (tapi data di LocalStorage aman)
                    lotOwned = INITIAL_STATE.lotOwned; 
                    rdnBalance = INITIAL_STATE.rdnBalance; 
                    isTransactionPending = INITIAL_STATE.isTransactionPending;
                    hasMadeFirstPurchase = INITIAL_STATE.hasMadeFirstPurchase;
                    isWithdrawalPending = INITIAL_STATE.isWithdrawalPending; 
                    
                    updateAuthUI();
                    updateUI();
                    showNotification("Berhasil Log Out. Data Anda tersimpan dan akan dimuat saat Log In kembali.", false, "Log Out Berhasil");
                }, 1500); // Jeda 1.5 detik
                
            } else {
                loginModal.classList.remove('hidden');
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (phone === CORRECT_PHONE && password === CORRECT_PASSWORD) {
                
                // Simpan status dan ID pengguna ke Local Storage (PERSISTENSI)
                localStorage.setItem(LOGGED_IN_KEY, 'true');
                localStorage.setItem(USER_ID_KEY, RDN_ACCOUNT_NUMBER);

                startTransition(() => {
                    currentUserId = RDN_ACCOUNT_NUMBER; 
                    loadData(); // MUAT DATA TERSIMPAN
                    updateAuthUI(); 
                    updateUI(); 
                    showNotification("Selamat datang, " + USER_NAME + ". Sesi Anda dipertahankan.", true, "Login Berhasil");
                    loginModal.classList.add('hidden'); 
                }, 1500); 
                
            } else {
                showNotification("Nomor HP atau Password salah. Coba lagi.", false, "Login Gagal");
            }
        }

        // FUNGSI UNTUK MODAL UMUM
        function updateModalLotLabel(action) {
            const isBuy = action === 'Beli';
            
            if (isBuy) {
                minLotWarning.textContent = `Pembelian wajib minimal ${MIN_BUY_LOTS.toLocaleString('id-ID')} lot.`; 
                minLotWarning.classList.remove('hidden');
                buyMethodText.classList.remove('hidden');
                lotsInput.setAttribute('min', MIN_BUY_LOTS);
                lotsInput.value = MIN_BUY_LOTS; 
            } else {
                minLotWarning.classList.add('hidden');
                buyMethodText.classList.add('hidden');
                lotsInput.setAttribute('min', 1);
                lotsInput.value = lotOwned > 0 ? lotOwned : 1; 
                lotsInput.setAttribute('max', lotOwned > 0 ? lotOwned : 1);
            }
        }

        function showModal(action) {
            if (!currentUserId) {
                 showNotification("Anda harus Log In terlebih dahulu untuk melakukan transaksi.", false, "Akses Ditolak");
                 return;
            }
            modalTitle.textContent = `${action} Saham GIAA`;
            submitButton.textContent = `Konfirmasi ${action}`;
            submitButton.className = action === 'Beli' 
                ? 'py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition duration-200' 
                : 'py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200';
            
            priceInput.value = currentPrice;
            orderTypeSelect.value = 'Limit'; 
            priceInput.readOnly = false;
            priceInput.classList.remove('bg-gray-100');
            
            updateModalLotLabel(action); 
            orderModal.classList.remove('hidden'); 
        }

        function hideModal() {
            orderModal.classList.add('hidden'); 
        }

        function openWithdrawalModal() {
            if (!currentUserId) {
                 showNotification("Anda harus Log In terlebih dahulu untuk mengakses menu dana.", false, "Akses Ditolak");
                 return;
            }

            document.getElementById('modal-user-name').textContent = USER_NAME;
            document.getElementById('modal-user-id').textContent = currentUserId;
            document.getElementById('modal-rdn-balance').textContent = formatRupiah(rdnBalance);
            // Menetapkan nilai awal pada input penarikan
            document.getElementById('withdrawalAmount').value = rdnBalance >= 100000 ? 100000 : (rdnBalance > 0 ? rdnBalance : 0); 
            
            withdrawalModal.classList.remove('hidden');
        }

        function closeWithdrawalModal() {
            withdrawalModal.classList.add('hidden');
        }

        // Event listener untuk Market Order
        orderTypeSelect.addEventListener('change', (e) => {
            const isMarket = e.target.value === 'Market';
            priceInput.readOnly = isMarket;
            if (isMarket) {
                priceInput.value = currentPrice;
                priceInput.classList.add('bg-gray-100');
            } else {
                priceInput.classList.remove('bg-gray-100');
            }
        });

        // ** INISIALISASI SAAT STARTUP DAN ATTACH LISTENERS **
        window.onload = function() {
            // Isi data statik 
            priceElement.textContent = currentPrice;
            changeElement.textContent = `+${priceChange} (+${percentChange}%)`;
            
            // --- LOGIKA PERSISTENSI LOGIN ---
            const savedLoginStatus = localStorage.getItem(LOGGED_IN_KEY);
            const savedUserId = localStorage.getItem(USER_ID_KEY);

            if (savedLoginStatus === 'true' && savedUserId) {
                // Sesi Ditemukan: Pulihkan sesi
                currentUserId = savedUserId;
                loadData(); 
                updateAuthUI(); 
                updateUI(); 
                showNotification("Sesi Anda dipulihkan. Selamat datang kembali!", true, "Aplikasi Siap");
            } else {
                // Sesi Tidak Ditemukan: Minta Login
                currentUserId = null;
                updateAuthUI(); 
                updateUI(); 
                loginModal.classList.remove('hidden'); 
            }
            
            // --- ATTACH EVENT LISTENERS ---
            
            // Auth Actions
            authStatusButton.addEventListener('click', handleAuthAction);
            loginForm.addEventListener('submit', handleLogin);
            
            // Trading Actions
            sellBtn.addEventListener('click', () => {
                const isUnlockedByRules = hasMadeFirstPurchase || rdnBalance > RDN_UNLOCK_THRESHOLD;
                
                if (!isUnlockedByRules) {
                    const message = "Penjualan saham akan berlaku jika user sudah melakukan pembelian saham pertama di aplikasi, atau saldo kas RDN Anda melebihi Rp 10 Juta.";
                    showNotification(message, false, "Jual Saham Dibatasi");
                } else if (lotOwned === 0) {
                     showNotification("GAGAL: Anda tidak memiliki Lot GIAA untuk dijual.", false, "Transaksi Gagal");
                } else {
                    showModal('Jual');
                }
            });

            buyBtn.addEventListener('click', () => showModal('Beli')); 
            withdrawalBtn.addEventListener('click', openWithdrawalModal); 

            // Form Submissions
            orderForm.addEventListener('submit', handleOrder);
            withdrawalForm.addEventListener('submit', handleWithdrawal); 
            
            // Modal Closures
            cancelOrderBtn.addEventListener('click', hideModal);
            cancelWithdrawalBtn.addEventListener('click', closeWithdrawalModal);

            // Payment Confirmation 
            paymentConfirmBtn.addEventListener('click', handlePaymentConfirmation);

            // Handle modal overlay clicks
            orderModal.addEventListener('click', hideModal);
            withdrawalModal.addEventListener('click', closeWithdrawalModal);
            paymentModal.addEventListener('click', closePaymentModal);

            // Prevent closing when clicking inside the modal content
            orderModalContent.addEventListener('click', (e) => e.stopPropagation());
            withdrawalModalContent.addEventListener('click', (e) => e.stopPropagation());
            paymentModalContent.addEventListener('click', (e) => e.stopPropagation());
        }
    </script>
</body>
</html>
